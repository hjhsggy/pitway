## redis持久化

### RDB (Redis DataBase)

### AOF (Append Only File)

- [] 实现方式

  - 写后日志, 类似于Mysql的binlog, 只记录执行成功的命令
  - AOF日志格式
  
  ```bash
  $ set key testdata
  ```

  ```text
  上述命令执行完, AOF日志内容如下:

    *3
    $3
    set
    $3
    key
    $8
    testdata

    *3 表示当前命令有几个部分
    $num 标识当前命令或者键值占多少字节
  ```
  
  - Q: AOF为什么要先执行再记录呢?
  - A:  
    - 传统的数据库日志, 例如redo log(重做日志文件), 记录的是修改后的数据, AOF记录的是redis收到的每一条命令
    - AOF记录的是每一条命令, 为了提高效率不会检查命令, 如果先记录再执行, 如果命令出错, redis回复数据就会有问题
    - 如果先写入后执行, 执行redis命令就会阻塞, 影响系统响应速度

- [] 三种写回策略

| 策略     | 写回时机 | 优点                   | 缺点                            |
| -------- | -------- | ---------------------- | ------------------------------- |
| Always   | 同步写回 | 可靠性高数据基本不丢失 | 每个命令都会写入磁盘,性能影响大 |
| Everysec | 每秒写回 | 性能适中               | 宕机时丢失一秒内的数据          |
| No       | 操作系统 | 性能好                 | 宕机时丢失数据较多              |
    
- [] 常见问题